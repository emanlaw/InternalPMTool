{% extends "base.html" %}

{% block content %}
<div class="gantt-container">
    <div class="gantt-header">
        <h1>üìä Project Gantt Chart</h1>
        <div class="gantt-controls">
            <!-- Enhanced Date Navigation -->
            <div class="date-navigation-section">
                <div class="quick-navigation">
                    <button class="nav-btn" onclick="navigateToToday()">üìç Today</button>
                    <button class="nav-btn" onclick="navigateToRange('week')">This Week</button>
                    <button class="nav-btn" onclick="navigateToRange('month')">This Month</button>
                    <button class="nav-btn" onclick="navigateToRange('quarter')">This Quarter</button>
                </div>
                <div class="date-controls">
                    <button class="nav-btn icon-btn" onclick="navigatePrevious()" title="Previous">‚Äπ</button>
                    <input type="month" id="monthPicker" onchange="navigateToMonth()" class="month-picker">
                    <button class="nav-btn icon-btn" onclick="navigateNext()" title="Next">‚Ä∫</button>
                </div>
            </div>
            
            <!-- View Mode and Zoom Controls -->
            <div class="view-controls">
                <div class="view-mode-selector">
                    <label>Timeline:</label>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm" data-view="day" onclick="changeViewMode('day')">Day</button>
                        <button class="btn btn-sm active" data-view="week" onclick="changeViewMode('week')">Week</button>
                        <button class="btn btn-sm" data-view="month" onclick="changeViewMode('month')">Month</button>
                        <button class="btn btn-sm" data-view="quarter" onclick="changeViewMode('quarter')">Quarter</button>
                    </div>
                </div>
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">üîç-</button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">üîç+</button>
                </div>
            </div>
            
            <!-- Project Filter and Actions -->
            <div class="filter-actions">
                <div class="project-filter">
                    <label>Project:</label>
                    <select id="projectFilter" onchange="filterByProject()">
                        <option value="">All Projects</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="gantt-actions">
                    <button class="btn btn-outline" onclick="toggleCriticalPath()">üîç Critical Path</button>
                    <button class="btn btn-primary" onclick="exportGantt()">üìÑ Export</button>
                </div>
            </div>
        </div>
    </div>

    <div class="gantt-timeline-container">
        <!-- Enhanced Timeline Header -->
        <div class="gantt-timeline-header">
            <div class="gantt-sidebar-header">
                <div class="header-title">Projects & Tasks</div>
                <div class="header-subtitle">Progress & Timeline</div>
            </div>
            <div class="gantt-dates-header" id="datesHeader">
                <!-- Enhanced date headers will be generated by JavaScript -->
                <div class="month-headers" id="monthHeaders"></div>
                <div class="date-columns" id="dateColumns"></div>
            </div>
        </div>

        <!-- Gantt Chart Body -->
        <div class="gantt-body">
            <div class="gantt-sidebar">
                {% for project in projects %}
                <div class="project-group" data-project-id="{{ project.id }}">
                    <div class="project-header" onclick="toggleProject('{{ project.id }}')">
                        <span class="expand-icon" id="expand-{{ project.id }}">‚ñº</span>
                        <span class="project-name">{{ project.name }}</span>
                        <span class="project-progress">{{ get_project_progress(project.id) }}%</span>
                    </div>
                    <div class="project-issues" id="issues-{{ project.id }}">
                        {% for card in cards %}
                        {% if card.project_id == project.id %}
                        <div class="issue-row" data-issue-id="{{ card.id }}" data-project-id="{{ project.id }}">
                            <div class="issue-info">
                                <span class="issue-id">#{{ card.id }}</span>
                                <span class="issue-title">{{ card.title }}</span>
                                <span class="issue-assignee">{{ card.assignee or 'Unassigned' }}</span>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="gantt-timeline" id="ganttTimeline">
                <!-- Timeline bars will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Today indicator -->
    <div class="today-indicator" id="todayIndicator"></div>
</div>

<!-- Issue Details Modal -->
<div id="issueModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Issue Details</h3>
            <button onclick="closeModal()" class="close-btn">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Issue details will be loaded here -->
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="saveIssueChanges()">Save Changes</button>
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
    </div>
</div>

<style>
/* Modern Gantt Chart Styles */
.gantt-container {
    padding: 20px;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.gantt-header {
    background: white;
    padding: 24px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: 1px solid rgba(255,255,255,0.2);
}

.gantt-header h1 {
    margin: 0 0 20px 0;
    color: #2c3e50;
    font-size: 28px;
    font-weight: 700;
}

.gantt-controls {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

/* Enhanced Date Navigation */
.date-navigation-section {
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
}

.quick-navigation {
    display: flex;
    gap: 8px;
}

.nav-btn {
    padding: 8px 16px;
    border: 1px solid #e1e8ed;
    border-radius: 6px;
    background: white;
    color: #5e6c84;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.nav-btn:hover {
    background: #f4f5f7;
    border-color: #ddd;
    color: #172b4d;
}

.nav-btn.active, .nav-btn:active {
    background: #0052cc;
    color: white;
    border-color: #0052cc;
}

.icon-btn {
    padding: 8px 12px;
    font-size: 16px;
    font-weight: bold;
}

.date-controls {
    display: flex;
    align-items: center;
    gap: 8px;
}

.month-picker {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: white;
    font-size: 14px;
}

/* View Controls and Zoom */
.view-controls {
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
}

.view-mode-selector {
    display: flex;
    align-items: center;
    gap: 10px;
}

.btn-group {
    display: flex;
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid #ddd;
}

.btn-group .btn {
    border: none;
    border-right: 1px solid #ddd;
    border-radius: 0;
    background: white;
    color: #5e6c84;
    padding: 8px 16px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-group .btn:last-child {
    border-right: none;
}

.btn-group .btn:hover {
    background: #f4f5f7;
}

.btn-group .btn.active {
    background: #0052cc;
    color: white;
}

.zoom-controls {
    display: flex;
    align-items: center;
    gap: 8px;
}

.zoom-btn {
    padding: 6px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s ease;
}

.zoom-btn:hover {
    background: #f4f5f7;
}

.zoom-level {
    font-size: 14px;
    font-weight: 500;
    color: #5e6c84;
    min-width: 40px;
    text-align: center;
}

/* Filter and Actions */
.filter-actions {
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
}

.gantt-controls label {
    font-weight: 600;
    color: #5e6c84;
    font-size: 14px;
}

.gantt-controls select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: white;
    font-size: 14px;
    min-width: 150px;
}

.btn {
    padding: 10px 20px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
}

.btn-primary {
    background: #0052cc;
    color: white;
}

.btn-primary:hover {
    background: #0065ff;
}

.btn-outline {
    background: white;
    color: #0052cc;
    border: 1px solid #0052cc;
}

.btn-outline:hover {
    background: #0052cc;
    color: white;
}

/* Enhanced Timeline Container */
.gantt-timeline-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.2);
}

.gantt-timeline-header {
    display: flex;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
    border-bottom: 1px solid rgba(255,255,255,0.2);
}

.gantt-sidebar-header {
    width: 320px;
    padding: 20px;
    border-right: 1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1);
}

.header-title {
    font-weight: 700;
    font-size: 16px;
    margin-bottom: 4px;
}

.header-subtitle {
    font-size: 12px;
    opacity: 0.8;
    font-weight: 400;
}

.gantt-dates-header {
    flex: 1;
    overflow-x: auto;
    position: relative;
}

.month-headers {
    display: flex;
    background: rgba(255,255,255,0.1);
    border-bottom: 1px solid rgba(255,255,255,0.2);
}

.month-header {
    padding: 8px 16px;
    text-align: center;
    font-weight: 600;
    font-size: 14px;
    border-right: 1px solid rgba(255,255,255,0.2);
    white-space: nowrap;
}

.date-columns {
    display: flex;
}

.date-column {
    min-width: 40px;
    padding: 12px 8px;
    text-align: center;
    border-right: 1px solid rgba(255,255,255,0.1);
    font-size: 12px;
    font-weight: 500;
    position: relative;
    transition: background-color 0.2s ease;
}

.date-column:hover {
    background: rgba(255,255,255,0.1);
}

.date-column.weekend {
    background: rgba(0,0,0,0.1);
}

.date-column.today {
    background: rgba(255,193,7,0.3);
    color: #fff;
    font-weight: 700;
    box-shadow: inset 0 0 0 2px rgba(255,193,7,0.5);
}

.date-column.today::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    border-bottom: 4px solid #ffc107;
}

/* Enhanced Sidebar and Content */
.gantt-body {
    display: flex;
    max-height: 70vh;
    overflow-y: auto;
}

.gantt-sidebar {
    width: 320px;
    border-right: 1px solid #e1e8ed;
    background: white;
}

.project-group {
    border-bottom: 1px solid #f4f5f7;
}

.project-header {
    padding: 16px 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 600;
    color: #2c3e50;
    border-bottom: 1px solid #e1e8ed;
    transition: all 0.2s ease;
}

.project-header:hover {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    transform: translateX(2px);
}

.expand-icon {
    font-size: 12px;
    transition: transform 0.3s ease;
    color: #6c757d;
    font-weight: bold;
}

.expand-icon.collapsed {
    transform: rotate(-90deg);
}

.project-name {
    flex: 1;
    font-size: 15px;
}

.project-progress {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
}

.project-issues {
    transition: max-height 0.3s ease;
    overflow: hidden;
    background: #fafbfc;
}

.project-issues.collapsed {
    max-height: 0;
}

.issue-row {
    padding: 14px 20px;
    border-bottom: 1px solid #f4f5f7;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.issue-row:hover {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.issue-row::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: transparent;
    transition: background 0.2s ease;
}

.issue-row:hover::before {
    background: #0052cc;
}

.issue-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.issue-id {
    font-weight: 700;
    color: #0052cc;
    min-width: 60px;
    font-size: 13px;
}

.issue-title {
    flex: 1;
    color: #2c3e50;
    font-size: 14px;
    line-height: 1.4;
}

.issue-assignee {
    font-size: 11px;
    color: #6c757d;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 4px 10px;
    border-radius: 12px;
    font-weight: 500;
    border: 1px solid #e1e8ed;
}

/* Enhanced Timeline and Bars */
.gantt-timeline {
    flex: 1;
    position: relative;
    overflow-x: auto;
    background: #fafbfc;
}

.timeline-row {
    height: 50px;
    border-bottom: 1px solid #f4f5f7;
    position: relative;
    transition: background-color 0.2s ease;
}

.timeline-row:hover {
    background: rgba(0, 82, 204, 0.02);
}

.project-timeline-row {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 2px solid #e1e8ed;
}

.timeline-bar {
    position: absolute;
    height: 28px;
    top: 11px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    padding: 0 12px;
    font-size: 12px;
    color: white;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    border: 2px solid transparent;
    overflow: hidden;
    position: relative;
}

.timeline-bar::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.1) 75%, transparent 75%);
    background-size: 8px 8px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.timeline-bar:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 8px 25px rgba(0,0,0,0.25);
    z-index: 10;
}

.timeline-bar:hover::before {
    opacity: 1;
}

/* Status-based styling */
.timeline-bar.status-todo {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    border-color: rgba(108, 117, 125, 0.3);
}

.timeline-bar.status-in_progress {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border-color: rgba(0, 123, 255, 0.3);
}

.timeline-bar.status-done {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    border-color: rgba(40, 167, 69, 0.3);
}

/* Priority indicators */
.timeline-bar.priority-high {
    border-left: 5px solid #dc3545;
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
}

.timeline-bar.priority-medium {
    border-left: 5px solid #ffc107;
    box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
}

.timeline-bar.priority-low {
    border-left: 5px solid #6f42c1;
    box-shadow: 0 2px 8px rgba(111, 66, 193, 0.3);
}

/* Progress indicator inside bars */
.timeline-bar-progress {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: rgba(255,255,255,0.2);
    border-radius: 6px;
    transition: width 0.3s ease;
}

.timeline-bar-text {
    position: relative;
    z-index: 2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Today indicator */
.today-indicator {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
    z-index: 15;
    pointer-events: none;
    box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
}

.today-indicator::before {
    content: 'TODAY';
    position: absolute;
    top: -25px;
    left: -20px;
    background: #ff6b6b;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
}

/* Enhanced Modal Styling */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 1000;
    backdrop-filter: blur(4px);
}

.modal-content {
    background: white;
    margin: 3% auto;
    padding: 0;
    width: 700px;
    max-width: 90vw;
    border-radius: 12px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 25px 50px rgba(0,0,0,0.25);
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-header {
    padding: 24px;
    border-bottom: 1px solid #e1e8ed;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px 12px 0 0;
}

.modal-header h3 {
    margin: 0;
    color: #2c3e50;
    font-size: 20px;
    font-weight: 700;
}

.modal-body {
    padding: 24px;
}

.modal-footer {
    padding: 20px 24px;
    border-top: 1px solid #e1e8ed;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    background: #f8f9fa;
    border-radius: 0 0 12px 12px;
}

.close-btn {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #6c757d;
    padding: 0;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.close-btn:hover {
    background: #f8f9fa;
    color: #343a40;
    transform: scale(1.1);
}

.issue-details {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #e1e8ed;
}

.badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.bg-success { background: #28a745 !important; color: white; }
.bg-primary { background: #007bff !important; color: white; }
.bg-secondary { background: #6c757d !important; color: white; }
.bg-danger { background: #dc3545 !important; color: white; }
.bg-warning { background: #ffc107 !important; color: #212529; }
.bg-info { background: #17a2b8 !important; color: white; }

.form-control {
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    width: 100%;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.form-control:focus {
    outline: none;
    border-color: #0052cc;
    box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.1);
}

/* Dark mode styles */
.dark-mode .gantt-container {
    background: #1a1a1a;
}

.dark-mode .gantt-header,
.dark-mode .gantt-timeline-container {
    background: #2d3748;
    color: #f5f5f5;
}

.dark-mode .gantt-sidebar-header,
.dark-mode .project-header {
    background: #374151;
    color: #f5f5f5;
}

.dark-mode .issue-row:hover {
    background: #374151;
}

.dark-mode .modal-content {
    background: #2d3748;
    color: #f5f5f5;
}
</style>

<script>
let currentViewMode = 'week';
let currentZoomLevel = 100;
let currentDateRange = null;
let ganttData = {
    projects: {{ projects | tojson }},
    cards: {{ cards | tojson }}
};

// Ensure we only work with active (non-archived) projects
ganttData.projects = ganttData.projects.filter(project => !project.archived);

document.addEventListener('DOMContentLoaded', function() {
    initializeGantt();
    setInitialMonth();
    generateTimeline();
    positionTodayIndicator();
    setActiveViewMode('week');
});

function initializeGantt() {
    // Initialize project collapse states
    ganttData.projects.forEach(project => {
        const issuesContainer = document.getElementById(`issues-${project.id}`);
        if (issuesContainer) {
            issuesContainer.style.maxHeight = issuesContainer.scrollHeight + 'px';
        }
    });
}

function setInitialMonth() {
    const monthPicker = document.getElementById('monthPicker');
    const today = new Date();
    const yearMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
    monthPicker.value = yearMonth;
}

function setActiveViewMode(mode) {
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.view === mode) {
            btn.classList.add('active');
        }
    });
}

// Enhanced Timeline Generation
function generateTimeline() {
    const monthHeaders = document.getElementById('monthHeaders');
    const dateColumns = document.getElementById('dateColumns');
    const ganttTimeline = document.getElementById('ganttTimeline');
    
    // Clear existing content
    monthHeaders.innerHTML = '';
    dateColumns.innerHTML = '';
    ganttTimeline.innerHTML = '';
    
    // Generate date range based on view mode
    const dateRange = generateDateRange();
    currentDateRange = dateRange;
    
    // Create month headers
    createMonthHeaders(dateRange, monthHeaders);
    
    // Create date columns
    createDateColumns(dateRange, dateColumns);
    
    // Create timeline rows
    createTimelineRows(dateRange, ganttTimeline);
}

function createMonthHeaders(dateRange, container) {
    const months = {};
    
    dateRange.forEach(date => {
        const monthKey = date.getFullYear() + '-' + date.getMonth();
        if (!months[monthKey]) {
            months[monthKey] = {
                name: date.toLocaleDateString('en', {month: 'long', year: 'numeric'}),
                count: 0
            };
        }
        months[monthKey].count++;
    });
    
    Object.values(months).forEach(month => {
        const monthHeader = document.createElement('div');
        monthHeader.className = 'month-header';
        monthHeader.style.width = (month.count * getColumnWidth()) + 'px';
        monthHeader.textContent = month.name;
        container.appendChild(monthHeader);
    });
}

function createDateColumns(dateRange, container) {
    dateRange.forEach(date => {
        const dateColumn = document.createElement('div');
        dateColumn.className = 'date-column';
        dateColumn.style.minWidth = getColumnWidth() + 'px';
        
        if (isWeekend(date)) {
            dateColumn.classList.add('weekend');
        }
        
        if (isToday(date)) {
            dateColumn.classList.add('today');
        }
        
        dateColumn.innerHTML = formatDateHeader(date);
        container.appendChild(dateColumn);
    });
}

function createTimelineRows(dateRange, container) {
    ganttData.projects.forEach(project => {
        // Project header row
        const projectRow = document.createElement('div');
        projectRow.className = 'timeline-row project-timeline-row';
        projectRow.style.height = '50px';
        container.appendChild(projectRow);
        
        // Issue rows
        const projectCards = ganttData.cards.filter(card => card.project_id == project.id);
        projectCards.forEach(card => {
            const issueRow = document.createElement('div');
            issueRow.className = 'timeline-row';
            issueRow.dataset.issueId = card.id;
            
            // Create enhanced timeline bar
            const timelineBar = createEnhancedTimelineBar(card, dateRange);
            if (timelineBar) {
                issueRow.appendChild(timelineBar);
            }
            
            container.appendChild(issueRow);
        });
    });
}

function createEnhancedTimelineBar(card, dateRange) {
    const startDate = new Date(card.created_at || new Date());
    const endDate = new Date(card.due_date || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000));
    
    const startIndex = dateRange.findIndex(date => 
        date.toDateString() === startDate.toDateString()
    );
    
    const endIndex = dateRange.findIndex(date => 
        date.toDateString() === endDate.toDateString()
    );
    
    if (startIndex === -1) return null;
    
    const bar = document.createElement('div');
    bar.className = `timeline-bar status-${card.status} priority-${card.priority.toLowerCase()}`;
    
    const columnWidth = getColumnWidth() * (currentZoomLevel / 100);
    const left = startIndex * columnWidth;
    const width = Math.max((endIndex - startIndex + 1) * columnWidth, columnWidth);
    
    bar.style.left = left + 'px';
    bar.style.width = width + 'px';
    
    // Add progress indicator
    const progressIndicator = document.createElement('div');
    progressIndicator.className = 'timeline-bar-progress';
    const progress = card.status === 'done' ? 100 : (card.status === 'in_progress' ? 50 : 10);
    progressIndicator.style.width = progress + '%';
    bar.appendChild(progressIndicator);
    
    // Add text
    const textElement = document.createElement('div');
    textElement.className = 'timeline-bar-text';
    textElement.textContent = card.title.length > 20 ? card.title.substring(0, 20) + '...' : card.title;
    bar.appendChild(textElement);
    
    bar.onclick = () => openIssueModal(card);
    
    // Add tooltip
    bar.title = `${card.title} (${card.status.replace('_', ' ')}) - ${card.assignee || 'Unassigned'}`;
    
    return bar;
}

// Enhanced Navigation Functions
function navigateToToday() {
    const today = new Date();
    const monthPicker = document.getElementById('monthPicker');
    const yearMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
    monthPicker.value = yearMonth;
    generateTimeline();
    positionTodayIndicator();
    
    // Scroll to today
    setTimeout(() => {
        const todayColumn = document.querySelector('.date-column.today');
        if (todayColumn) {
            todayColumn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
    }, 100);
}

function navigateToRange(range) {
    const today = new Date();
    let targetDate = today;
    
    switch(range) {
        case 'week':
            // Stay on current week
            break;
        case 'month':
            targetDate = new Date(today.getFullYear(), today.getMonth(), 1);
            break;
        case 'quarter':
            const quarter = Math.floor(today.getMonth() / 3);
            targetDate = new Date(today.getFullYear(), quarter * 3, 1);
            break;
    }
    
    const monthPicker = document.getElementById('monthPicker');
    const yearMonth = targetDate.getFullYear() + '-' + String(targetDate.getMonth() + 1).padStart(2, '0');
    monthPicker.value = yearMonth;
    generateTimeline();
    positionTodayIndicator();
}

function navigatePrevious() {
    const monthPicker = document.getElementById('monthPicker');
    const currentDate = new Date(monthPicker.value + '-01');
    currentDate.setMonth(currentDate.getMonth() - 1);
    const yearMonth = currentDate.getFullYear() + '-' + String(currentDate.getMonth() + 1).padStart(2, '0');
    monthPicker.value = yearMonth;
    generateTimeline();
    positionTodayIndicator();
}

function navigateNext() {
    const monthPicker = document.getElementById('monthPicker');
    const currentDate = new Date(monthPicker.value + '-01');
    currentDate.setMonth(currentDate.getMonth() + 1);
    const yearMonth = currentDate.getFullYear() + '-' + String(currentDate.getMonth() + 1).padStart(2, '0');
    monthPicker.value = yearMonth;
    generateTimeline();
    positionTodayIndicator();
}

function navigateToMonth() {
    generateTimeline();
    positionTodayIndicator();
}

// Zoom Functions
function zoomIn() {
    if (currentZoomLevel < 200) {
        currentZoomLevel += 25;
        updateZoomLevel();
        generateTimeline();
        positionTodayIndicator();
    }
}

function zoomOut() {
    if (currentZoomLevel > 50) {
        currentZoomLevel -= 25;
        updateZoomLevel();
        generateTimeline();
        positionTodayIndicator();
    }
}

function updateZoomLevel() {
    document.getElementById('zoomLevel').textContent = currentZoomLevel + '%';
}

function generateDateRange() {
    const monthPicker = document.getElementById('monthPicker');
    const baseDate = monthPicker.value ? new Date(monthPicker.value + '-01') : new Date();
    const dates = [];
    
    let startDate, endDate, increment;
    
    switch (currentViewMode) {
        case 'day':
            startDate = new Date(baseDate.getTime() - 7 * 24 * 60 * 60 * 1000);
            endDate = new Date(baseDate.getTime() + 21 * 24 * 60 * 60 * 1000);
            increment = 1;
            break;
        case 'week':
            startDate = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1);
            endDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + 2, 0);
            increment = 1;
            break;
        case 'month':
            startDate = new Date(baseDate.getFullYear(), baseDate.getMonth() - 1, 1);
            endDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + 3, 0);
            increment = 1;
            break;
        case 'quarter':
            startDate = new Date(baseDate.getFullYear(), 0, 1);
            endDate = new Date(baseDate.getFullYear() + 1, 0, 0);
            increment = 7;
            break;
    }
    
    for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + increment)) {
        dates.push(new Date(date));
    }
    
    return dates;
}

function getColumnWidth() {
    const baseWidth = {
        'day': 80,
        'week': 50,
        'month': 35,
        'quarter': 25
    };
    return baseWidth[currentViewMode] || 40;
}

function formatDateHeader(date) {
    switch (currentViewMode) {
        case 'day':
            return `<div style="font-weight: 600;">${date.getDate()}</div><div style="font-size: 10px;">${date.toLocaleDateString('en', {weekday: 'short'})}</div>`;
        case 'week':
            return `<div style="font-weight: 600;">${date.getDate()}</div><div style="font-size: 10px;">${date.toLocaleDateString('en', {weekday: 'short'})}</div>`;
        case 'month':
            return `<div style="font-weight: 600;">${date.getDate()}</div>`;
        case 'quarter':
            return `<div style="font-size: 10px;">${date.toLocaleDateString('en', {month: 'short'})}</div><div style="font-weight: 600;">${date.getDate()}</div>`;
        default:
            return date.getDate().toString();
    }
}

function isWeekend(date) {
    const day = date.getDay();
    return day === 0 || day === 6;
}

function isToday(date) {
    const today = new Date();
    return date.toDateString() === today.toDateString();
}

function getWeekNumber(date) {
    const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
    const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
    return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
}

function positionTodayIndicator() {
    if (!currentDateRange) return;
    
    const today = new Date();
    const todayIndex = currentDateRange.findIndex(date => 
        date.toDateString() === today.toDateString()
    );
    
    if (todayIndex !== -1) {
        const indicator = document.getElementById('todayIndicator');
        const left = 320 + (todayIndex * getColumnWidth() * (currentZoomLevel / 100)) + (getColumnWidth() * (currentZoomLevel / 100) / 2);
        indicator.style.left = left + 'px';
        indicator.style.display = 'block';
    }
}

function changeViewMode(mode) {
    if (mode) {
        currentViewMode = mode;
    } else {
        currentViewMode = document.getElementById('viewMode').value;
    }
    setActiveViewMode(currentViewMode);
    generateTimeline();
    positionTodayIndicator();
}

function toggleProject(projectId) {
    const issuesContainer = document.getElementById(`issues-${projectId}`);
    const expandIcon = document.getElementById(`expand-${projectId}`);
    
    if (issuesContainer.classList.contains('collapsed')) {
        issuesContainer.classList.remove('collapsed');
        issuesContainer.style.maxHeight = issuesContainer.scrollHeight + 'px';
        expandIcon.classList.remove('collapsed');
    } else {
        issuesContainer.classList.add('collapsed');
        issuesContainer.style.maxHeight = '0';
        expandIcon.classList.add('collapsed');
    }
    
    // Regenerate timeline to match sidebar
    setTimeout(() => {
        generateTimeline();
        positionTodayIndicator();
    }, 300);
}

function filterByProject() {
    const selectedProject = document.getElementById('projectFilter').value;
    
    document.querySelectorAll('.project-group').forEach(group => {
        if (!selectedProject || group.dataset.projectId === selectedProject) {
            group.style.display = 'block';
        } else {
            group.style.display = 'none';
        }
    });
    
    generateTimeline();
    positionTodayIndicator();
}

function openIssueModal(card) {
    const modal = document.getElementById('issueModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    
    modalTitle.textContent = `#${card.id} - ${card.title}`;
    modalBody.innerHTML = `
        <div class="issue-details" style="margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <p><strong>Description:</strong><br>${card.description || 'No description'}</p>
                    <p><strong>Status:</strong> <span class="badge bg-${card.status === 'done' ? 'success' : card.status === 'in_progress' ? 'primary' : 'secondary'}">${card.status.replace('_', ' ').toUpperCase()}</span></p>
                    <p><strong>Priority:</strong> <span class="badge bg-${card.priority === 'High' ? 'danger' : card.priority === 'Medium' ? 'warning' : 'info'}">${card.priority}</span></p>
                </div>
                <div>
                    <p><strong>Assignee:</strong> ${card.assignee || 'Unassigned'}</p>
                    <p><strong>Created:</strong> ${new Date(card.created_at).toLocaleDateString()}</p>
                    <p><strong>Due Date:</strong> ${card.due_date ? new Date(card.due_date).toLocaleDateString() : 'Not set'}</p>
                </div>
            </div>
        </div>
        <div class="issue-actions">
            <div style="margin-bottom: 10px;">
                <label><strong>Update Due Date:</strong></label>
                <input type="date" id="newDueDate" value="${card.due_date || ''}" class="form-control" style="margin-top: 5px;">
            </div>
        </div>
    `;
    
    modal.style.display = 'block';
    modal.dataset.cardId = card.id;
}

function closeModal() {
    document.getElementById('issueModal').style.display = 'none';
}

function saveIssueChanges() {
    const modal = document.getElementById('issueModal');
    const cardId = modal.dataset.cardId;
    const newDueDate = document.getElementById('newDueDate').value;
    
    // Update the card data
    const card = ganttData.cards.find(c => c.id == cardId);
    if (card && newDueDate) {
        card.due_date = newDueDate;
        
        // Send update to server
        fetch('/api/update_card_due_date', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                card_id: cardId,
                due_date: newDueDate
            })
        }).then(() => {
            generateTimeline();
            positionTodayIndicator();
            closeModal();
        }).catch(error => {
            console.error('Error updating due date:', error);
            alert('Error updating due date. Please try again.');
        });
    }
}

function exportGantt() {
    // Enhanced export functionality
    const printStyles = `
        <style>
            @media print {
                .gantt-controls { display: none !important; }
                .gantt-container { background: white !important; }
                .gantt-timeline-container { box-shadow: none !important; }
                .today-indicator::before { display: none !important; }
            }
        </style>
    `;
    document.head.insertAdjacentHTML('beforeend', printStyles);
    window.print();
}

function toggleCriticalPath() {
    // Enhanced critical path analysis
    const criticalTasks = ganttData.cards.filter(card => 
        card.priority === 'High' && card.status !== 'done'
    );
    
    if (criticalTasks.length > 0) {
        alert(`Critical Path Analysis:\n\n${criticalTasks.length} high-priority tasks need attention:\n${criticalTasks.map(task => `‚Ä¢ ${task.title}`).join('\n')}`);
    } else {
        alert('Great! No critical path issues detected.');
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('issueModal');
    if (event.target === modal) {
        closeModal();
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
    if (event.key === 't' && event.ctrlKey) {
        event.preventDefault();
        navigateToToday();
    }
});
</script>
{% endblock %}