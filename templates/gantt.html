{% extends "base.html" %}

{% block content %}
<div class="gantt-container">
    <div class="gantt-header">
        <h1>üìä Project Gantt Chart</h1>
        <div class="gantt-controls">
            <div class="date-range-selector">
                <label>View:</label>
                <select id="viewMode" onchange="changeViewMode()">
                    <option value="month">Month View</option>
                    <option value="week">Week View</option>
                    <option value="day">Day View</option>
                    <option value="quarter">Quarter View</option>
                </select>
            </div>
            <div class="project-filter">
                <label>Project:</label>
                <select id="projectFilter" onchange="filterByProject()">
                    <option value="">All Projects</option>
                    {% for project in projects %}
                    <option value="{{ project.id }}">{{ project.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="gantt-actions">
                <button class="btn" onclick="exportGantt()">üìÑ Export PDF</button>
                <button class="btn btn-secondary" onclick="toggleCriticalPath()">üîç Critical Path</button>
            </div>
        </div>
    </div>

    <div class="gantt-timeline-container">
        <!-- Timeline Header -->
        <div class="gantt-timeline-header">
            <div class="gantt-sidebar-header">Projects & Issues</div>
            <div class="gantt-dates-header" id="datesHeader">
                <!-- Date headers will be generated by JavaScript -->
            </div>
        </div>

        <!-- Gantt Chart Body -->
        <div class="gantt-body">
            <div class="gantt-sidebar">
                {% for project in projects %}
                <div class="project-group" data-project-id="{{ project.id }}">
                    <div class="project-header" onclick="toggleProject('{{ project.id }}')">
                        <span class="expand-icon" id="expand-{{ project.id }}">‚ñº</span>
                        <span class="project-name">{{ project.name }}</span>
                        <span class="project-progress">{{ get_project_progress(project.id) }}%</span>
                    </div>
                    <div class="project-issues" id="issues-{{ project.id }}">
                        {% for card in cards %}
                        {% if card.project_id == project.id %}
                        <div class="issue-row" data-issue-id="{{ card.id }}" data-project-id="{{ project.id }}">
                            <div class="issue-info">
                                <span class="issue-id">#{{ card.id }}</span>
                                <span class="issue-title">{{ card.title }}</span>
                                <span class="issue-assignee">{{ card.assignee or 'Unassigned' }}</span>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="gantt-timeline" id="ganttTimeline">
                <!-- Timeline bars will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Today indicator -->
    <div class="today-indicator" id="todayIndicator"></div>
</div>

<!-- Issue Details Modal -->
<div id="issueModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Issue Details</h3>
            <button onclick="closeModal()" class="close-btn">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Issue details will be loaded here -->
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="saveIssueChanges()">Save Changes</button>
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
    </div>
</div>

<style>
.gantt-container {
    padding: 20px;
    background: #f8f9fa;
    min-height: 100vh;
}

.gantt-header {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.gantt-header h1 {
    margin: 0 0 15px 0;
    color: #172b4d;
}

.gantt-controls {
    display: flex;
    gap: 20px;
    align-items: center;
    flex-wrap: wrap;
}

.gantt-controls > div {
    display: flex;
    align-items: center;
    gap: 8px;
}

.gantt-controls label {
    font-weight: 500;
    color: #5e6c84;
}

.gantt-controls select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
}

.gantt-timeline-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.gantt-timeline-header {
    display: flex;
    background: #f4f5f7;
    border-bottom: 2px solid #ddd;
    position: sticky;
    top: 0;
    z-index: 10;
}

.gantt-sidebar-header {
    width: 300px;
    padding: 15px 20px;
    font-weight: 600;
    color: #172b4d;
    border-right: 1px solid #ddd;
    background: #f4f5f7;
}

.gantt-dates-header {
    flex: 1;
    display: flex;
    overflow-x: auto;
}

.date-column {
    min-width: 40px;
    padding: 10px 5px;
    text-align: center;
    border-right: 1px solid #eee;
    font-size: 12px;
    color: #5e6c84;
}

.date-column.weekend {
    background: #f8f9fa;
}

.date-column.today {
    background: #e3f2fd;
    color: #0052cc;
    font-weight: bold;
}

.gantt-body {
    display: flex;
    max-height: 600px;
    overflow-y: auto;
}

.gantt-sidebar {
    width: 300px;
    border-right: 1px solid #ddd;
    background: white;
}

.project-group {
    border-bottom: 1px solid #eee;
}

.project-header {
    padding: 15px 20px;
    background: #f8f9fa;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    color: #172b4d;
    border-bottom: 1px solid #ddd;
}

.project-header:hover {
    background: #e4e6ea;
}

.expand-icon {
    font-size: 12px;
    transition: transform 0.2s;
}

.expand-icon.collapsed {
    transform: rotate(-90deg);
}

.project-name {
    flex: 1;
}

.project-progress {
    background: #e3f2fd;
    color: #0052cc;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
}

.project-issues {
    transition: max-height 0.3s ease;
    overflow: hidden;
}

.project-issues.collapsed {
    max-height: 0;
}

.issue-row {
    padding: 12px 20px;
    border-bottom: 1px solid #f4f5f7;
    cursor: pointer;
}

.issue-row:hover {
    background: #f8f9fa;
}

.issue-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.issue-id {
    font-weight: 600;
    color: #0079bf;
    min-width: 80px;
}

.issue-title {
    flex: 1;
    color: #172b4d;
    font-size: 14px;
}

.issue-assignee {
    font-size: 12px;
    color: #5e6c84;
    background: #f4f5f7;
    padding: 2px 8px;
    border-radius: 12px;
}

.gantt-timeline {
    flex: 1;
    position: relative;
    overflow-x: auto;
}

.timeline-row {
    height: 45px;
    border-bottom: 1px solid #f4f5f7;
    position: relative;
}

.timeline-bar {
    position: absolute;
    height: 24px;
    top: 10px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    padding: 0 8px;
    font-size: 12px;
    color: white;
    font-weight: 500;
    transition: all 0.2s;
}

.timeline-bar:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.timeline-bar.status-todo {
    background: #6c757d;
}

.timeline-bar.status-in_progress {
    background: #0079bf;
}

.timeline-bar.status-done {
    background: #36b37e;
}

.timeline-bar.priority-high {
    border: 2px solid #ff5630;
}

.timeline-bar.priority-medium {
    border: 2px solid #ffab00;
}

.timeline-bar.priority-low {
    border: 2px solid #36b37e;
}

.today-indicator {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #ff5630;
    z-index: 5;
    pointer-events: none;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
}

.modal-content {
    background: white;
    margin: 50px auto;
    padding: 0;
    width: 600px;
    border-radius: 8px;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid #eee;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #5e6c84;
}

.close-btn:hover {
    color: #172b4d;
}

/* Dark mode styles */
.dark-mode .gantt-container {
    background: #1a1a1a;
}

.dark-mode .gantt-header,
.dark-mode .gantt-timeline-container {
    background: #2d3748;
    color: #f5f5f5;
}

.dark-mode .gantt-sidebar-header,
.dark-mode .project-header {
    background: #374151;
    color: #f5f5f5;
}

.dark-mode .issue-row:hover {
    background: #374151;
}

.dark-mode .modal-content {
    background: #2d3748;
    color: #f5f5f5;
}
</style>

<script>
let currentViewMode = 'month';
let ganttData = {
    projects: {{ projects | tojson }},
    cards: {{ cards | tojson }}
};

// Ensure we only work with active (non-archived) projects
ganttData.projects = ganttData.projects.filter(project => !project.archived);

document.addEventListener('DOMContentLoaded', function() {
    initializeGantt();
    generateTimeline();
    positionTodayIndicator();
});

function initializeGantt() {
    // Initialize project collapse states
    ganttData.projects.forEach(project => {
        const issuesContainer = document.getElementById(`issues-${project.id}`);
        if (issuesContainer) {
            issuesContainer.style.maxHeight = issuesContainer.scrollHeight + 'px';
        }
    });
}

function generateTimeline() {
    const datesHeader = document.getElementById('datesHeader');
    const ganttTimeline = document.getElementById('ganttTimeline');
    
    // Clear existing content
    datesHeader.innerHTML = '';
    ganttTimeline.innerHTML = '';
    
    // Generate date range based on view mode
    const dateRange = generateDateRange();
    
    // Create date headers
    dateRange.forEach(date => {
        const dateColumn = document.createElement('div');
        dateColumn.className = 'date-column';
        dateColumn.style.minWidth = getColumnWidth() + 'px';
        
        if (isWeekend(date)) {
            dateColumn.classList.add('weekend');
        }
        
        if (isToday(date)) {
            dateColumn.classList.add('today');
        }
        
        dateColumn.innerHTML = formatDateHeader(date);
        datesHeader.appendChild(dateColumn);
    });
    
    // Create timeline rows for each project and issue
    ganttData.projects.forEach(project => {
        // Project header row
        const projectRow = document.createElement('div');
        projectRow.className = 'timeline-row project-timeline-row';
        projectRow.style.height = '47px';
        ganttTimeline.appendChild(projectRow);
        
        // Issue rows
        const projectCards = ganttData.cards.filter(card => card.project_id == project.id);
        projectCards.forEach(card => {
            const issueRow = document.createElement('div');
            issueRow.className = 'timeline-row';
            issueRow.dataset.issueId = card.id;
            
            // Create timeline bar for the issue
            const timelineBar = createTimelineBar(card, dateRange);
            if (timelineBar) {
                issueRow.appendChild(timelineBar);
            }
            
            ganttTimeline.appendChild(issueRow);
        });
    });
}

function createTimelineBar(card, dateRange) {
    const startDate = new Date(card.created_at || new Date());
    const endDate = new Date(card.due_date || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000));
    
    const startIndex = dateRange.findIndex(date => 
        date.toDateString() === startDate.toDateString()
    );
    
    const endIndex = dateRange.findIndex(date => 
        date.toDateString() === endDate.toDateString()
    );
    
    if (startIndex === -1) return null;
    
    const bar = document.createElement('div');
    bar.className = `timeline-bar status-${card.status} priority-${card.priority.toLowerCase()}`;
    
    const columnWidth = getColumnWidth();
    const left = startIndex * columnWidth;
    const width = Math.max((endIndex - startIndex + 1) * columnWidth, columnWidth);
    
    bar.style.left = left + 'px';
    bar.style.width = width + 'px';
    bar.textContent = card.title.length > 20 ? card.title.substring(0, 20) + '...' : card.title;
    
    bar.onclick = () => openIssueModal(card);
    
    return bar;
}

function generateDateRange() {
    const today = new Date();
    const dates = [];
    
    let startDate, endDate, increment;
    
    switch (currentViewMode) {
        case 'day':
            startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            endDate = new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000);
            increment = 1;
            break;
        case 'week':
            startDate = new Date(today.getTime() - 4 * 7 * 24 * 60 * 60 * 1000);
            endDate = new Date(today.getTime() + 8 * 7 * 24 * 60 * 60 * 1000);
            increment = 7;
            break;
        case 'month':
            startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 4, 0);
            increment = 1;
            break;
        case 'quarter':
            startDate = new Date(today.getFullYear(), 0, 1);
            endDate = new Date(today.getFullYear() + 1, 0, 0);
            increment = 30;
            break;
    }
    
    for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + increment)) {
        dates.push(new Date(date));
    }
    
    return dates;
}

function getColumnWidth() {
    switch (currentViewMode) {
        case 'day': return 60;
        case 'week': return 80;
        case 'month': return 40;
        case 'quarter': return 30;
        default: return 40;
    }
}

function formatDateHeader(date) {
    switch (currentViewMode) {
        case 'day':
            return `<div>${date.getDate()}</div><div>${date.toLocaleDateString('en', {weekday: 'short'})}</div>`;
        case 'week':
            return `<div>Week ${getWeekNumber(date)}</div><div>${date.getMonth() + 1}/${date.getDate()}</div>`;
        case 'month':
            return `<div>${date.getDate()}</div>`;
        case 'quarter':
            return `<div>${date.toLocaleDateString('en', {month: 'short'})}</div><div>${date.getDate()}</div>`;
        default:
            return date.getDate().toString();
    }
}

function isWeekend(date) {
    const day = date.getDay();
    return day === 0 || day === 6;
}

function isToday(date) {
    const today = new Date();
    return date.toDateString() === today.toDateString();
}

function getWeekNumber(date) {
    const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
    const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
    return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
}

function positionTodayIndicator() {
    const today = new Date();
    const dateRange = generateDateRange();
    const todayIndex = dateRange.findIndex(date => 
        date.toDateString() === today.toDateString()
    );
    
    if (todayIndex !== -1) {
        const indicator = document.getElementById('todayIndicator');
        const left = 300 + (todayIndex * getColumnWidth()) + (getColumnWidth() / 2);
        indicator.style.left = left + 'px';
        indicator.style.display = 'block';
    }
}

function changeViewMode() {
    currentViewMode = document.getElementById('viewMode').value;
    generateTimeline();
    positionTodayIndicator();
}

function toggleProject(projectId) {
    const issuesContainer = document.getElementById(`issues-${projectId}`);
    const expandIcon = document.getElementById(`expand-${projectId}`);
    
    if (issuesContainer.classList.contains('collapsed')) {
        issuesContainer.classList.remove('collapsed');
        issuesContainer.style.maxHeight = issuesContainer.scrollHeight + 'px';
        expandIcon.classList.remove('collapsed');
    } else {
        issuesContainer.classList.add('collapsed');
        issuesContainer.style.maxHeight = '0';
        expandIcon.classList.add('collapsed');
    }
    
    // Regenerate timeline to match sidebar
    setTimeout(() => {
        generateTimeline();
        positionTodayIndicator();
    }, 300);
}

function filterByProject() {
    const selectedProject = document.getElementById('projectFilter').value;
    
    document.querySelectorAll('.project-group').forEach(group => {
        if (!selectedProject || group.dataset.projectId === selectedProject) {
            group.style.display = 'block';
        } else {
            group.style.display = 'none';
        }
    });
    
    generateTimeline();
    positionTodayIndicator();
}

function openIssueModal(card) {
    const modal = document.getElementById('issueModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    
    modalTitle.textContent = `#${card.id} - ${card.title}`;
    modalBody.innerHTML = `
        <div class="issue-details">
            <p><strong>Description:</strong> ${card.description || 'No description'}</p>
            <p><strong>Status:</strong> ${card.status.replace('_', ' ').toUpperCase()}</p>
            <p><strong>Priority:</strong> ${card.priority}</p>
            <p><strong>Assignee:</strong> ${card.assignee || 'Unassigned'}</p>
            <p><strong>Created:</strong> ${card.created_at}</p>
            <p><strong>Due Date:</strong> ${card.due_date || 'Not set'}</p>
        </div>
        <div class="issue-actions">
            <label>Update Due Date:</label>
            <input type="date" id="newDueDate" value="${card.due_date || ''}">
        </div>
    `;
    
    modal.style.display = 'block';
    modal.dataset.cardId = card.id;
}

function closeModal() {
    document.getElementById('issueModal').style.display = 'none';
}

function saveIssueChanges() {
    const modal = document.getElementById('issueModal');
    const cardId = modal.dataset.cardId;
    const newDueDate = document.getElementById('newDueDate').value;
    
    // Update the card data
    const card = ganttData.cards.find(c => c.id == cardId);
    if (card && newDueDate) {
        card.due_date = newDueDate;
        
        // Send update to server
        fetch('/api/update_card_due_date', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                card_id: cardId,
                due_date: newDueDate
            })
        }).then(() => {
            generateTimeline();
            positionTodayIndicator();
            closeModal();
        });
    }
}

function exportGantt() {
    // Simple export functionality - can be enhanced
    window.print();
}

function toggleCriticalPath() {
    // Placeholder for critical path functionality
    alert('Critical path analysis coming soon!');
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('issueModal');
    if (event.target === modal) {
        closeModal();
    }
}
</script>
{% endblock %}